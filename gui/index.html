<!-- @author git:drhino -->
<!-- @version lib:0.0.1 / file:0.0.1  -->
<link href="style.css" rel="stylesheet">

<header>
	<div>
		<svg id="logo" width="76" height="124" alt="Logo of Ollama AI combined with the V8 logo"
			viewBox="0 0 38 62"
			xmlns="http://www.w3.org/2000/svg"
			xmlns:xlink="http://www.w3.org/1999/xlink">
			<g id="logo-ollama">
				<path d="m30.981 39.26a7.9 7.9 0 0 0 .218-3.453 7.359 7.359 0 0 0 -1.032-2.7c-.562-1 .257-1.651.689-2.495a7 7 0 0 0 .761-2.886 8.887 8.887 0 0 0 -.345-2.995c-.242-.806-.895-1.56-1.063-2.354-.289-1.364 1.39-2.783 1.526-4.32a6.5 6.5 0 0 0 -1.469-4.9 5.45 5.45 0 0 0 -4.03-2.084 6.658 6.658 0 0 0 -.955.085c-.873.079-1.122-1.1-1.564-1.667a6.079 6.079 0 0 0 -1.982-1.625 5.784 5.784 0 0 0 -5.26-.111 6.512 6.512 0 0 0 -2.311 1.864c-.789 1.075-.55 1.373-1.884 1.492-2.391.212-4.28 1.022-5.386 3.321a6.185 6.185 0 0 0 .027 5.791 3.649 3.649 0 0 0 .653.855 1.16 1.16 0 0 1 .171 1.544 8.277 8.277 0 0 0 -.409 8.246c.892 1.664.479 1.9-.163 3.651a8.851 8.851 0 0 0 -.1 4.74h-2.309a10.322 10.322 0 0 1 -.155-3.311c.121-1.072 1-2.513.965-3.49-.034-.923-.923-2.012-1.141-2.969a10.629 10.629 0 0 1 -.143-3.632 28.6 28.6 0 0 1 .878-3.09c.267-1.154-.326-1.608-.733-2.786a8.666 8.666 0 0 1 .7-6.939 8.255 8.255 0 0 1 1.925-2.25c.808-.722.19-2.444.18-3.411a13.281 13.281 0 0 1 .56-4.145c.63-1.978 2.7-4.515 4.823-2.494 1.4 1.335 1.666 3.242 2.031 5.046.068.34.106.369.416.212a8.952 8.952 0 0 1 2.677-.948 7.916 7.916 0 0 1 5.022.875c.565.293.564.287.661-.359a10.755 10.755 0 0 1 1.046-3.546 4.186 4.186 0 0 1 1.279-1.54 2.343 2.343 0 0 1 3.1.269 6.405 6.405 0 0 1 1.645 3.41 14.789 14.789 0 0 1 .3 3.911c-.048.885-.53 2.1.252 2.775a7.035 7.035 0 0 1 1.806 2.1 9.965 9.965 0 0 1 1.142 4.353 8.042 8.042 0 0 1 -.285 2.17c-.2.727-.959 1.664-1 2.371-.073 1.185.86 2.652 1.043 3.9a10.274 10.274 0 0 1 -.465 4.832 9.375 9.375 0 0 0 -.894 1.9 6.166 6.166 0 0 0 .694 1.647 10.305 10.305 0 0 1 .2 5.152h-2.312c.366-1.145.77-.012 0-.012zm-21.555-31.803c.023.355.05.845.087 1.334.03.386.084.4.455.345.621-.1 1.244-.207 1.87-.246 1.768-.109.125-5.522-.578-6.392-.262-.324-.5-.333-.707.024a9.887 9.887 0 0 0 -1.127 4.935c.023.355.037-1.314 0 0zm19.2-.044a9.12 9.12 0 0 0 -1.2-4.981c-.56-.8-3.692 6.468-1.118 6.465a8.977 8.977 0 0 1 1.8.261c.716.148.494-1.349.521-1.746-.062-1.426-.029.434.002.001z"/>
				<path d="m19.032 26.117a6.964 6.964 0 0 1 -3.235-.459 4.869 4.869 0 0 1 -2.4-2.084 4.135 4.135 0 0 1 .495-4.62 6.022 6.022 0 0 1 3.821-2.2 6.858 6.858 0 0 1 5.042.937 4.773 4.773 0 0 1 2.31 3.276 4.119 4.119 0 0 1 -2.065 4.302 7.327 7.327 0 0 1 -3.972.848c-1.105.059.272 0 .004 0zm-.012-8.017a4.6 4.6 0 0 0 -.48 0 4.714 4.714 0 0 0 -3.758 2.121 2.659 2.659 0 0 0 .621 3.508c1.583 1.244 4.479 1.289 6.3.568a2.837 2.837 0 0 0 .759-5.031 5.146 5.146 0 0 0 -3.442-1.166c-.16 0 1.287-.022 0 0z"/>
				<g class="logo-ollama-eye">
					<path d="m11.307 19.961a1.316 1.316 0 0 1 -1.409-1.4 1.614 1.614 0 0 1 1.559-1.661 1.421 1.421 0 0 1 1.374 1.378 1.686 1.686 0 0 1 -1.524 1.682z"/>
				</g>
				<g class="logo-ollama-eye">
					<path d="m28.157 18.626a1.323 1.323 0 0 1 -1.44 1.335 1.724 1.724 0 0 1 -1.5-1.679 1.422 1.422 0 0 1 1.4-1.382 1.656 1.656 0 0 1 1.535 1.726z"/>
				</g>
				<path d="m18.363 22.348a2.425 2.425 0 0 1 .031-.242.972.972 0 0 0 -.569-.924c-.38-.42 0-.8.451-.933.341-.1.926.058 1.327-.009a.569.569 0 0 1 .649.3c.288.536-.748 1.2-.639 1.938.1.719-1.267.742-1.25-.126.006-.052-.009.442 0-.004z"/>
			</g>
			<g id="logo-v8">
				<clipPath id="a">
					<path d="m38 31.773-3.455 6.045-.972 1.727h-2.331l-2.98 5.635a9.522 9.522 0 0 1 -6.11 11.1l-3.152 5.72-3.131-5.722-.324-.108a9.543 9.543 0 0 1 -5.807-11.011l-2.958-5.613h-2.332l-.993-1.728-3.455-6.045h9.932l1.619 3.217.086.043.022-.043a7.341 7.341 0 0 1 14.639 0l-.043.043-.022-.043 1.835-3.217z"/>
				</clipPath>
				<radialGradient id="b" cx="-.438" cy="32.085" gradientTransform="matrix(.952 0 0 -.952 .914 62.704)" gradientUnits="userSpaceOnUse" r="42.052">
					<stop offset="0" stop-color="#fff" stop-opacity=".1"/>
					<stop offset="1" stop-color="#fff" stop-opacity="0"/>
				</radialGradient>
				<g clip-path="url(#a)">
					<path d="m31.847 37.6-.928 1.943h2.634l.13-.216.97-1.727zm-25.737 0h-2.763l1.1 1.943h2.613z" fill="#9e9e9e"/>
					<path d="m38 31.773-3.455 6.045h-2.418l-3.865 7.362-9.262 16.82-9.262-16.841-3.865-7.341h-2.418l-3.455-6.045h9.932l1.619 3.217 5.268 9.61 2.159 3.951 2.073-3.951 5.182-9.608 1.835-3.217" fill="#424242"/>
					<path d="m10.053 31.989h-9.932l-.121-.216h9.932zm18.015-.216-.119.216h9.928l.123-.216z" fill="#fff" fill-opacity=".2"/>
					<path d="m33.69 39.325-.125.22h-2.345l-2.964 5.625-9.256 16.83-9.256-16.834-2.958-5.62h-2.347l-.121-.216h2.468l.114.216 2.844 5.4 9.256 16.838 9.256-16.83 2.967-5.629" fill="#263238" fill-opacity=".2"/>
					<path d="m22.67 47.318a3.67 3.67 0 1 1 -3.67-3.67 3.67 3.67 0 0 1 3.67 3.67zm-.431-11.227a3.239 3.239 0 1 1 -3.239-3.239 3.239 3.239 0 0 1 3.239 3.239z" fill="#fff"/>
					<path d="m28.263 45.181a9.538 9.538 0 0 0 -3.282-5.247 7.332 7.332 0 1 0 -11.961 0 9.518 9.518 0 1 0 15.243 5.247zm-9.263-12.113a3.023 3.023 0 1 1 -3.023 3.023 3.023 3.023 0 0 1 3.023-3.023zm0 17.7a3.448 3.448 0 1 1 3.455-3.455 3.465 3.465 0 0 1 -3.455 3.46z" fill="#4285f4"/>
					<g fill-opacity=".2">
						<path d="m26.341 35.659v.108a7.342 7.342 0 0 0 -14.682 0v-.108a7.341 7.341 0 0 1 14.682 0zm-13.408 4.351a9.478 9.478 0 0 0 -3.433 7.308v.108a9.485 9.485 0 0 1 3.528-7.28l.1-.08-.1-.13-.1.086v-.012zm12.134 0-.1-.08-.1.136.1.086a9.48 9.48 0 0 1 3.533 7.276v-.108a9.446 9.446 0 0 0 -3.433-7.3z" fill="#fff"/>
						<path d="m28.5 47.21v.108a9.5 9.5 0 0 1 -19 0v-.108a9.5 9.5 0 0 0 19 0zm-16.841-11.659v.108a7.3 7.3 0 0 0 1.468 4.4c.035-.022.069-.052.108-.078a7.315 7.315 0 0 1 -1.576-4.43zm14.682 0a7.31 7.31 0 0 1 -1.576 4.435c.039.026.073.054.108.08a7.246 7.246 0 0 0 1.468-4.4v-.11z" fill="#263238"/>
					</g>
				</g>
				<path d="m38 31.773-3.455 6.045-.972 1.727h-2.353l-2.958 5.635a9.522 9.522 0 0 1 -6.11 11.1l-3.152 5.72-3.131-5.722-.324-.108a9.543 9.543 0 0 1 -5.807-11.011l-2.958-5.613h-2.332l-.993-1.728-3.455-6.045h9.932l1.619 3.217.086.043.022-.043a7.341 7.341 0 0 1 14.639 0l-.043.043-.022-.043 1.835-3.217z" fill="url(#b)"/>
			</g>
		</svg>

		<nav>
			<ul>
				<li>
					<a href="#ask-ollama" class="active">Ask Ollama</a>
				</li>
				<li>
					<a href="#create-model">Create Model</a>
				</li>
				<li>
					<a href="#model-manager">Model Manager</a> <!-- list + duplicate + delete + download -->
				</li>
				<li>
					<a href="#create-embedding">Create Embedding</a>
				</li>
			</ul>
		</nav>
	</div>
</header>

<aside>
	<div>
		<span id="status"></span>
		<input id="server" type="text" placeholder="http://127.0.0.1:11434">
		<button id="update" disabled>&#10144;</button>
	</div>
	<div class="text-right">
		<select id="models"></select>
		<button id="stop" disabled><span></span></button>
	</div>
</aside>

<main>
	<h2>Ask Ollama.</h2>

	<p id="error"></p>

	<section>
		<div>
			<div>
				<textarea id="prompt" rows="10" placeholder="Ask me anything!">&#x1F3B6; My milkshake brings all the boys to the </textarea>
			</div>
			<button id="ask">Ask.</button>
		</div>
		<div>
			<pre id="stream"></pre>
		</div>
	</section>

	<pre id="result"></pre>
</main>

<footer>
	<a target="_blank" href="https://ollama.ai/">Ollama</a>
	client
	<a target="_blank" href="https://github.com/drhino/ollama-client">v0.0.1</a>
	powered by
	<a target="_blank" href="https://v8.dev/">V8.</a>
</footer>

<script type="module">
	import Ollama from './OllamaRequest.js'

	/** @var {LocalStorage} */
	const { localStorage } = window

	/** @var {string} */
	const namespace = 'ollama.'

	/** @var ?Ollama */
	let ollama

	/** @var ?bool */
	let isOnline

	const el = {
		status: document.getElementById('status'),
		server: document.getElementById('server'),
		update: document.getElementById('update'),
		error:  document.getElementById('error'),
		result: document.getElementById('result'),
		prompt: document.getElementById('prompt'),
		models: document.getElementById('models'),
		stop:   document.getElementById('stop'),
		ask:    document.getElementById('ask'),
		stream: document.getElementById('stream'),

		// modelfile <textarea>
		// table <table>
		// embedding <textarea>
	}

	/**
	 * Constructs a new Ollama instance with the given url.
	 *
	 * @param {string} url to the Ollama server.
	 *
	 * @return {undefined}
	 */
	const setUrl = url => {
		// Ignores re-constructing the instance when the url is the same
		if (ollama?.url === url) return

		ollama?.stop() // aborts a processing request
		ollama?.ignore() // removes the watcher
		ollama = new Ollama(url)

		ollama.ononline = async() => {
			isOnline = true
			el.status.setAttribute('class', 'online')
			el.stop.setAttribute('disabled', true) // default state = disabled
			el.ask.removeAttribute('disabled')

			console.log('server back online')

			// Adds the models into the view
			await ollama.listModels().then(models => {
				// Remove the previous list (if any)
				el.models.textContent = ''

				// Construct the latest listing
				for (const model of models) {
					el.models.appendChild(new Option(model.name))
				}
			})

			// Fetches the last chosen model upon page load
			// Does nothing when we were offline and are now back online
			const firstModel = el.models.value
			el.models.value = localStorage.getItem(namespace + 'model')
			// Sets the model back to the original value when the value
			//   in localStorage does not match any of the options
			if (el.models.value.length === 0) el.models.value = firstModel
		}

		ollama.onoffline = reason => {
			isOnline = false
			el.status.setAttribute('class', 'offline')
			el.stop.setAttribute('disabled', true)
			el.ask.setAttribute('disabled', true)

			console.log('connection lost')
		}

		ollama.watch()
	}

	// Handles cancelling a request
	el.stop.onclick = event => {
		event.target.blur()
		ollama?.stop()
	}

	// Stores the model in the client's browser
	el.models.onchange = () => {
		localStorage.setItem(namespace + 'model', el.models.value)
	}

	// Store the URL in the client's browser and re-construct the instance
	el.update.onclick = event => {
		event.target.blur()
		localStorage.setItem(namespace + 'url', el.server.value)
		setUrl(el.server.value)
	}

	// Finds the configured url, or use the default
	const url = localStorage.getItem(namespace + 'url') ?? 'http://127.0.0.1:11434'

	// Set the URL into the view
	el.server.value = url

	// Bootstraps the application
	setUrl(url)

	// Enables changing the URL
	el.update.removeAttribute('disabled')
	
	// Post the `Ask Ollama` form
	// Prints to the console to add additional value to this example interface
	el.ask.onclick = async() => {
		// lock
		el.ask.setAttribute('disabled', true)
		// reset
		el.stream.textContent = ''
		el.result.textContent = ''
		el.error.textContent  = ''
		el.prompt.classList.remove('error')
		// enable cancel
		el.stop.removeAttribute('disabled')

		const body = {
			model: el.models.value,
			prompt: el.prompt.value,
		}

		console.log('Request Body:', body)

		const result = await ollama.generate(body, stream => {
			console.log('Stream:', stream)

			// Adds the token into the view
			el.stream.textContent += stream.response ?? ''
		})
		.catch(e => {
			switch (e.toString()) {
				case 'Error: Prompt cannot be empty':
					el.prompt.classList.add('error')
					// Shows the error in the view
					el.error.textContent = e
					break

				case 'AbortError: The user aborted a request.':
					// Ignore the error
					break

				default:
					console.log(e.name, e, [ e ], [ e.toString() ])
					throw e // ... @TODO: use break
			}
		})

		if (result) {
			console.log('Resolves:', result)

			el.result.textContent = JSON.stringify(result, null, 4)
		}

		// unlock
		el.ask.removeAttribute('disabled')
		// disabled cancel
		el.stop.setAttribute('disabled', true)
	}

	/*
	console.log( await ollama.generate({ model: 'orca', prompt: 'hi' }, json => {
		console.log('buffer', json)
	}) )
	*/

	/*
	const rs = await ollama.generate({ model: 'orca', prompt: 'hi' })
	console.log(rs.toString())
	console.log(`${rs}`)
	*/

	/*try {
		await ollama.createModel('mymodel1', '/Users/x/Applications/ollama/discord-ai-bot-custom/Modelfile')
			// .catch(e => console.error('made a booboo', e))
	} catch (e) {
		console.error('oepsie', e)
	}*/

	// ---
	// createModel(name, path)
	// await ollama.listModels().then(models => console.log(models))
	// copyModel(source, destination)
	// deleteModel(model)
	// pullModel(model)
	// embedding(model, prompt)
	// ---

	// import { registryModels } from './registryModels.js'
	// await ollama.listAllModels().then(models => console.log(models))
	// await ollama.listAllModels('codeup').then(response => console.log(response))
	/*
	const result = {}
	for (const model of registryModels)
		result[model] = await ollama.listAllModels(model)
	console.log(result)
	*/

	// Blinks the eyes
	const closeEye = eye => eye.style.transform = 'scaleY(0.5) translateY(-13px)'
	const openEye = eye => eye.style.transform = 'scaleY(1) translateY(0)'
	document.querySelectorAll('.logo-ollama-eye').forEach(eye => {
		setInterval(() => {
			closeEye(eye)
			setTimeout(() => openEye(eye), 100)
			setTimeout(() => closeEye(eye), 200)
			setTimeout(() => openEye(eye), 300)
		}, 3000)
	})

</script>
